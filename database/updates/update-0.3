#! /usr/bin/perl
#
$LAST_VERSION	= '0.2';
$VERSION	= '0.3';

use Pg;

$dbmain = "ldp";
@row;

$conn=Pg::connectdb("dbname=$dbmain");

$result = $conn->exec("SELECT value FROM config WHERE name='version'");
die $conn->errorMessage unless PGRES_TUPLES_OK eq $result->resultStatus;

@row = $result->fetchrow;

$version = $row[0];
$version =~ s/\s+$//;
if ($version ne $LAST_VERSION) {
	print "ERROR: This script can only update from version $LAST_VERSION to $VERSION\n";
	exit(1);
}

# i18n support in class table
#
$sql = "CREATE TABLE class_new (class_id INT4 NOT NULL, PRIMARY KEY (class_id))";
$conn->exec($sql);
$sql = "CREATE TABLE class_i18n (class_id INT4 NOT NULL, lang CHAR(2) NOT NULL, class_name CHAR(20) NOT NULL, class_description TEXT NOT NULL, PRIMARY KEY (class_id, lang))";
$conn->exec($sql);

$sql = "SELECT class, class_name FROM class";
$result = $conn->exec("$sql");
die $conn->errorMessage unless PGRES_TUPLES_OK eq $result->resultStatus;
$class_id = 0;
while (@row = $result->fetchrow) {
	$class = $row[0];
	$class_name = $row[1];
	$class_id++;
	$sql = "INSERT INTO class_new (class_id) VALUES ($class_id)";
	$conn->exec($sql);
	$sql = "INSERT INTO class_i18n(class_id, lang, class_name, class_description) VALUES ($class_id, 'EN', '$class', '$class_name')";
	$conn->exec($sql);
}


# Update document table
#
$sql = "CREATE TABLE document_new (doc_id INT4 NOT NULL, title TEXT NOT NULL, class_id INT4, format CHAR(12), dtd CHAR(12), dtd_version CHAR(12), version CHAR(12), last_update DATE, URL TEXT, ISBN TEXT, pub_status CHAR, review_status CHAR, tickle_date DATE, pub_date DATE, ref_url TEXT, tech_review_status CHAR, maintained BOOLEAN DEFAULT False, license CHAR(12), abstract TEXT, rating REAL, PRIMARY KEY (doc_id))";
$conn->exec("$sql");
$sql = "INSERT INTO document_new SELECT doc_id, title, class_id, format, dtd, dtd_version, version, last_update, url, isbn, pub_status, review_status, tickle_date, pub_date, ref_url, tech_review_status, maintained, license, abstract, rating FROM document d, class_i18n c WHERE d.class=c.class_name";
$conn->exec("$sql");


# Copy new tables over old tables
#
$conn->exec("DROP TABLE class");
$conn->exec("ALTER TABLE class_new RENAME TO class");
$conn->exec("DROP TABLE document");
$conn->exec("ALTER TABLE document_new RENAME TO document");


# Update database version
#
$conn->exec("UPDATE config SET value='$VERSION' WHERE name='version'");
