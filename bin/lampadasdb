#!/bin/sh

SQLDIR=/usr/local/share/lampadas/sql
TABLESDIR=$SQLDIR/tables

usage()
{
	echo "\
Usage: lampadas.sh [-h | --help] ACTION DATABASE

Where ACTION is one of:

    create       Create new data tables.
    defaults     Insert default values
    drop         Drop all tables.
    delete       Delete all data.
    load         Load data from files in /tmp.
    save         Copy data to files in /tmp.
"
}

find_sql()
{
  local name=${1:-create}
  find $TABLESDIR -type f -name $1 -maxdepth 2 -mindepth 2
}

find_table()
{
  # first -e removes trailing file name, e.g. "/create.sql"
  # second -e removes all leading directories
  find_sql "$@" | sed -e "s#/$1\$##" -e "s#.*/##"
}
create()
{
  find_sql create.sql | xargs -r cat
  find_sql view.sql | xargs -r cat
  find_sql indexes.sql | xargs -r cat
  find_sql permissions.sql | xargs -r cat
}

drop()
{
  find_table create.sql | sed -e 's#\(.*\)#DROP TABLE \1;#'
  find_table view.sql | sed -e 's#\(.*\)#DROP VIEW \1;#'
}

delete()
{
  find_table create.sql | sed -e 's#\(.*\)#DELETE from \1;#'
}

load()
{
  find_table create.sql | sed -e "s#\(.*\)#copy \1 from '/tmp/\1';#"
}

save()
{
  find_table create.sql | sed -e "s#\(.*\)#copy \1 to '/tmp/\1';#"
}

defaults()
{
  find_table insert.m4 \
  | while read table
  do
    find $TABLESDIR/$table -type f -name '[A-Z][A-Z].m4' \
    | while read file
    do
      lang=${file%.m4}
      lang=${lang##*/}
      echo "-- $table/$lang --"
      m4 -P -DI18N_lang_code=${lang} "$TABLESDIR/$table/insert.m4" $file
      echo ""
    done
  done
}

#---------------------------------------------
# main()

while test $# -gt 0 ; do
    case "${1}" in
	-h | --help )
		usage
		exit 1
		;;
	"create" | "drop" | "delete" | "load" | "save" | "defaults" )
		break
		;;
	*)	echo "Invalid command: $1"
		exit 1
		;;
    esac
done

if [ $# -ne 2 ]; then
 	usage
	exit 1
fi

(
  echo "-- Created by lampadasdb.sh, do not edit"
  date "+-- %c"
  echo
  "$@" 
) > $TABLESDIR/$1.sql \
&& psql $2 -qf $TABLESDIR/$1.sql
