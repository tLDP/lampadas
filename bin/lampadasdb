#!/bin/sh

SQLDIR=/usr/local/share/lampadas/sql

usage()
{
	echo "\
Usage: lampadas.sh [-h | --help] ACTION DATABASE

Where ACTION is one of:

	create
		Create new data tables.

	drop
		Drop all tables.
		
	delete
		Delete all data.
		
	load
		Load data from files in /tmp.
	
	save
		Copy data to files in /tmp.
"
}

create()
{
	psql $1 -qf "$2/create.sql"
}

drop()
{
	psql $1 -c "DROP TABLE $3;"
}

delete()
{
	psql $1 -c "DELETE from $3;"
}

load()
{
	psql $1 -c "copy $3 from '/tmp/$3';"
}

save()
{
	echo "Saving $3"
}

#---------------------------------------------
# main()

while test $# -gt 0 ; do
    case "${1}" in
	-h | --help )
		usage
		exit 1
		;;
	"usage" | "create" | "drop" | "delete" | "load" | "save" )
		COMMAND="${1}"
		shift
		DBNAME="${1}"
		break
		;;
	*)	echo "Invalid command: ${1}"
		exit 1
		;;
    esac
done

if [ -z "$COMMAND" -o -z "$DBNAME" ]; then
 	usage
	exit 1
fi

find $SQLDIR/tables -type d -maxdepth 1 -mindepth 1 ! -name CVS \
| while read tab
do
	"$COMMAND" "$DBNAME" "$tab" $(basename "$tab")
done 
