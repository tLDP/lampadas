#!/bin/sh

usage()
{
	echo "\
Usage: lampadas.sh [-h | --help] ACTION DATABASE

Where ACTION is one of:

	create
		Create new data tables.
		
	delete
		Delete all data.
		
	load
		Load data from files in /tmp.
	
	save
		Copy data to files in /tmp.
"
}

#---------------------------------------------
# main()

if [ "$#" = 0 ]; then
    usage;
    exit 1
fi

create()
{
	if [ "$DBNAME" = "" ]; then
		exit 1
	else
		echo "Creating $DBNAME"
		psql $DBNAME -qf audience.sql
		psql $DBNAME -qf block.sql
		psql $DBNAME -qf block_i18n.sql
		psql $DBNAME -qf class.sql
		psql $DBNAME -qf class_i18n.sql
		psql $DBNAME -qf config.sql
		psql $DBNAME -qf document.sql
		psql $DBNAME -qf document_audience.sql
		psql $DBNAME -qf document_error.sql
		psql $DBNAME -qf document_file.sql
		psql $DBNAME -qf document_rev.sql
		psql $DBNAME -qf document_topic.sql
		psql $DBNAME -qf document_user.sql
		psql $DBNAME -qf document_wiki.sql
		psql $DBNAME -qf doc_vote.sql
		psql $DBNAME -qf dtd.sql
		psql $DBNAME -qf error.sql
		psql $DBNAME -qf error_i18n.sql
		psql $DBNAME -qf format.sql
		psql $DBNAME -qf format_i18n.sql
		psql $DBNAME -qf language.sql
		psql $DBNAME -qf language_i18n.sql
		psql $DBNAME -qf license.sql
		psql $DBNAME -qf notes.sql
		psql $DBNAME -qf page.sql
		psql $DBNAME -qf page_i18n.sql
		psql $DBNAME -qf pub_status.sql
		psql $DBNAME -qf pub_status_i18n.sql
		psql $DBNAME -qf review_status.sql
		psql $DBNAME -qf review_status_i18n.sql
		psql $DBNAME -qf role.sql
		psql $DBNAME -qf section.sql
		psql $DBNAME -qf section_i18n.sql
		psql $DBNAME -qf stats.sql
		psql $DBNAME -qf stats_cdf.sql
		psql $DBNAME -qf string.sql
		psql $DBNAME -qf string_i18n.sql
		psql $DBNAME -qf subtopic.sql
		psql $DBNAME -qf template.sql
		psql $DBNAME -qf topic.sql
		psql $DBNAME -qf topic_i18n.sql
		psql $DBNAME -qf username.sql
		psql $DBNAME -qf username_notes.sql
	fi
}

delete()
{
	if [ "$DBNAME" = "" ]; then
		echo "Deleting $DBNAME"
		psql $DBNAME -c "delete from audience;"
		psql $DBNAME -c "delete from block;"
		psql $DBNAME -c "delete from block_i18n;"
		psql $DBNAME -c "delete from class;"
		psql $DBNAME -c "delete from class_i18n;"
		psql $DBNAME -c "delete from config;"
		psql $DBNAME -c "delete from doc_vote;"
		psql $DBNAME -c "delete from document;"
		psql $DBNAME -c "delete from document_audience;"
		psql $DBNAME -c "delete from document_error;"
		psql $DBNAME -c "delete from document_file;"
		psql $DBNAME -c "delete from document_rev;"
		psql $DBNAME -c "delete from document_topic;"
		psql $DBNAME -c "delete from document_user;"
		psql $DBNAME -c "delete from document_wiki;"
		psql $DBNAME -c "delete from dtd;"
		psql $DBNAME -c "delete from error;"
		psql $DBNAME -c "delete from error_i18n;"
		psql $DBNAME -c "delete from format;"
		psql $DBNAME -c "delete from format_i18n;"
		psql $DBNAME -c "delete from language;"
		psql $DBNAME -c "delete from language_i18n;"
		psql $DBNAME -c "delete from license;"
		psql $DBNAME -c "delete from notes;"
		psql $DBNAME -c "delete from page;"
		psql $DBNAME -c "delete from page_i18n;"
		psql $DBNAME -c "delete from pub_status;"
		psql $DBNAME -c "delete from pub_status_i18n;"
		psql $DBNAME -c "delete from review_status;"
		psql $DBNAME -c "delete from review_status_i18n;"
		psql $DBNAME -c "delete from role;"
		psql $DBNAME -c "delete from section;"
		psql $DBNAME -c "delete from section_i18n;"
		psql $DBNAME -c "delete from stats;"
		psql $DBNAME -c "delete from stats_cdf;"
		psql $DBNAME -c "delete from string;"
		psql $DBNAME -c "delete from string_i18n;"
		psql $DBNAME -c "delete from subtopic;"
		psql $DBNAME -c "delete from template;"
		psql $DBNAME -c "delete from topic;"
		psql $DBNAME -c "delete from topic_i18n;"
		psql $DBNAME -c "delete from username;"
		psql $DBNAME -c "delete from username_notes;"
	fi
}

load()
{
	if [ "$DBNAME" = "" ]; then
		exit 1
	else
		echo "Loading $DBNAME"
		psql $DBNAME -c "copy audience from '/tmp/lampadas_audience.txt';"
		psql $DBNAME -c "copy block from '/tmp/lampadas_block.txt';"
		psql $DBNAME -c "copy block_i18n from '/tmp/lampadas_block_i18n.txt';"
		psql $DBNAME -c "copy class from '/tmp/lampadas_class.txt';"
		psql $DBNAME -c "copy class_i18n from '/tmp/lampadas_class_i18n.txt';"
		psql $DBNAME -c "copy config from '/tmp/lampadas_config.txt';"
		psql $DBNAME -c "copy doc_vote from '/tmp/lampadas_doc_vote.txt';"
		psql $DBNAME -c "copy document from '/tmp/lampadas_document.txt';"
		psql $DBNAME -c "copy document_audience from '/tmp/lampadas_document_audience.txt';"
		psql $DBNAME -c "copy document_error from '/tmp/lampadas_document_error.txt';"
		psql $DBNAME -c "copy document_file from '/tmp/lampadas_document_file.txt';"
		psql $DBNAME -c "copy document_rev from '/tmp/lampadas_document_rev.txt';"
		psql $DBNAME -c "copy document_topic from '/tmp/lampadas_document_topic.txt';"
		psql $DBNAME -c "copy document_user from '/tmp/lampadas_document_user.txt';"
		psql $DBNAME -c "copy document_wiki from '/tmp/lampadas_document_wiki.txt';"
		psql $DBNAME -c "copy dtd from '/tmp/lampadas_dtd.txt';"
		psql $DBNAME -c "copy error from '/tmp/lampadas_error.txt';"
		psql $DBNAME -c "copy error_i18n from '/tmp/lampadas_error_i18n.txt';"
		psql $DBNAME -c "copy format from '/tmp/lampadas_format.txt';"
		psql $DBNAME -c "copy format_i18n from '/tmp/lampadas_format_i18n.txt';"
		psql $DBNAME -c "copy language from '/tmp/lampadas_language.txt';"
		psql $DBNAME -c "copy language_i18n from '/tmp/lampadas_language_i18n.txt';"
		psql $DBNAME -c "copy license from '/tmp/lampadas_license.txt';"
		psql $DBNAME -c "copy notes from '/tmp/lampadas_notes.txt';"
		psql $DBNAME -c "copy page from '/tmp/lampadas_page.txt';"
		psql $DBNAME -c "copy page_i18n from '/tmp/lampadas_page_i18n.txt';"
		psql $DBNAME -c "copy pub_status from '/tmp/lampadas_pub_status.txt';"
		psql $DBNAME -c "copy pub_status_i18n from '/tmp/lampadas_pub_status_i18n.txt';"
		psql $DBNAME -c "copy review_status from '/tmp/lampadas_review_status.txt';"
		psql $DBNAME -c "copy review_status_i18n from '/tmp/lampadas_review_status_i18n.txt';"
		psql $DBNAME -c "copy role from '/tmp/lampadas_role.txt';"
		psql $DBNAME -c "copy section from '/tmp/lampadas_section.txt';"
		psql $DBNAME -c "copy section_i18n from '/tmp/lampadas_section_i18n.txt';"
		psql $DBNAME -c "copy stats from '/tmp/lampadas_stats.txt';"
		psql $DBNAME -c "copy stats_cdf from '/tmp/lampadas_stats_cdf.txt';"
		psql $DBNAME -c "copy string from '/tmp/lampadas_string.txt';"
		psql $DBNAME -c "copy string_i18n from '/tmp/lampadas_string_i18n.txt';"
		psql $DBNAME -c "copy subtopic from '/tmp/lampadas_subtopic.txt';"
		psql $DBNAME -c "copy template from '/tmp/lampadas_template.txt';"
		psql $DBNAME -c "copy topic from '/tmp/lampadas_topic.txt';"
		psql $DBNAME -c "copy topic_i18n from '/tmp/lampadas_topic_i18n.txt';"
		psql $DBNAME -c "copy username from '/tmp/lampadas_username.txt';"
		psql $DBNAME -c "copy username_notes from '/tmp/lampadas_username_notes.txt';"
	fi
}

save()
{
	if [ "$DBNAME" = "" ]; then
		exit 1
	else
		echo "Saving $DBNAME"
		psql $DBNAME -c "copy audience to '/tmp/lampadas_audience.txt';"
		psql $DBNAME -c "copy block to '/tmp/lampadas_block.txt';"
		psql $DBNAME -c "copy block_i18n to '/tmp/lampadas_block_i18n.txt';"
		psql $DBNAME -c "copy class to '/tmp/lampadas_class.txt';"
		psql $DBNAME -c "copy class_i18n to '/tmp/lampadas_class_i18n.txt';"
		psql $DBNAME -c "copy config to '/tmp/lampadas_config.txt';"
		psql $DBNAME -c "copy doc_vote to '/tmp/lampadas_doc_vote.txt';"
		psql $DBNAME -c "copy document to '/tmp/lampadas_document.txt';"
		psql $DBNAME -c "copy document_audience to '/tmp/lampadas_document_audience.txt';"
		psql $DBNAME -c "copy document_error to '/tmp/lampadas_document_error.txt';"
		psql $DBNAME -c "copy document_file to '/tmp/lampadas_document_file.txt';"
		psql $DBNAME -c "copy document_rev to '/tmp/lampadas_document_rev.txt';"
		psql $DBNAME -c "copy document_topic to '/tmp/lampadas_document_topic.txt';"
		psql $DBNAME -c "copy document_user to '/tmp/lampadas_document_user.txt';"
		psql $DBNAME -c "copy document_wiki to '/tmp/lampadas_document_wiki.txt';"
		psql $DBNAME -c "copy dtd to '/tmp/lampadas_dtd.txt';"
		psql $DBNAME -c "copy error to '/tmp/lampadas_error.txt';"
		psql $DBNAME -c "copy error_i18n to '/tmp/lampadas_error_i18n.txt';"
		psql $DBNAME -c "copy format to '/tmp/lampadas_format.txt';"
		psql $DBNAME -c "copy format_i18n to '/tmp/lampadas_format_i18n.txt';"
		psql $DBNAME -c "copy language to '/tmp/lampadas_language.txt';"
		psql $DBNAME -c "copy language_i18n to '/tmp/lampadas_language_i18n.txt';"
		psql $DBNAME -c "copy license to '/tmp/lampadas_license.txt';"
		psql $DBNAME -c "copy notes to '/tmp/lampadas_notes.txt';"
		psql $DBNAME -c "copy page to '/tmp/lampadas_page.txt';"
		psql $DBNAME -c "copy page_i18n to '/tmp/lampadas_page_i18n.txt';"
		psql $DBNAME -c "copy pub_status to '/tmp/lampadas_pub_status.txt';"
		psql $DBNAME -c "copy pub_status_i18n to '/tmp/lampadas_pub_status_i18n.txt';"
		psql $DBNAME -c "copy review_status to '/tmp/lampadas_review_status.txt';"
		psql $DBNAME -c "copy review_status_i18n to '/tmp/lampadas_review_status_i18n.txt';"
		psql $DBNAME -c "copy role to '/tmp/lampadas_role.txt';"
		psql $DBNAME -c "copy section to '/tmp/lampadas_section.txt';"
		psql $DBNAME -c "copy section_i18n to '/tmp/lampadas_section_i18n.txt';"
		psql $DBNAME -c "copy stats to '/tmp/lampadas_stats.txt';"
		psql $DBNAME -c "copy stats_cdf to '/tmp/lampadas_stats_cdf.txt';"
		psql $DBNAME -c "copy string to '/tmp/lampadas_string.txt';"
		psql $DBNAME -c "copy string_i18n to '/tmp/lampadas_string_i18n.txt';"
		psql $DBNAME -c "copy subtopic to '/tmp/lampadas_subtopic.txt';"
		psql $DBNAME -c "copy template to '/tmp/lampadas_template.txt';"
		psql $DBNAME -c "copy topic to '/tmp/lampadas_topic.txt';"
		psql $DBNAME -c "copy topic_i18n to '/tmp/lampadas_topic_i18n.txt';"
		psql $DBNAME -c "copy username to '/tmp/lampadas_username.txt';"
		psql $DBNAME -c "copy username_notes to '/tmp/lampadas_username_notes.txt';"
	fi
}

while test $# -gt 0 ; do
    case "${1}" in
	-h | --help )
	    COMMAND="usage"; shift ;;
	create )
	    COMMAND="create"; shift ;;
	delete )
		COMMAND="delete"; shift ;;
	load )
	    COMMAND="load"; shift ;;
	save )
	    COMMAND="save"; shift ;;
	* )
	    DBNAME="${1}"; shift ;;
    esac
done

case "$COMMAND" in
	"usage" )
		usage;;
	"create" )
		create;;
	"delete" )
		delete;;
	"load" )
		load;;
	"save" )
		save;;
esac

