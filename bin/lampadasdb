#!/bin/sh

SQLDIR=/usr/local/share/lampadas/sql

usage()
{
	echo "\
Usage: lampadas.sh [-h | --help] ACTION DATABASE

Where ACTION is one of:

	create
		Create new data tables.

	drop
		Drop all tables.
		
	delete
		Delete all data.
		
	load
		Load data from files in /tmp.
	
	save
		Copy data to files in /tmp.
"
}

#---------------------------------------------
# main()

if [ "$#" = 0 ]; then
    usage;
    exit 1
fi

create()
{
	if [ "$DBNAME" = "" ]; then
		exit 1
	else
		echo "Creating $DBNAME"
		for tab in $SQLDIR/tables/* ; do
		    psql $DBNAME -qf $tab/create.sql
		done
	fi
}

drop()
{
	if [ "$DBNAME" = "" ]; then
		exit 1
	else
		echo "Dropping all tables in $DBNAME"
		for tab in $SQLDIR/tables/* ; do
		    psql $DBNAME -c 'DROP TABLE $tab;'
		done 
	fi
}

delete()
{
	if [ "$DBNAME" = "" ]; then
		echo "Deleting $DBNAME"
		for tab in $SQLDIR/tables/* ; do
		    psql $DBNAME -c 'DELETE from $tab;'
		done 
	fi
}

load()
{
	if [ "$DBNAME" = "" ]; then
		exit 1
	else
		echo "Loading $DBNAME"
		for tab in $SQLDIR/tables/* ; do
		    psql $DBNAME -c "copy $tab from '/tmp/$tab';"
		done 
	fi
}

save()
{
	if [ "$DBNAME" = "" ]; then
		exit 1
	else
		echo "Saving $DBNAME"
		for tab in $SQLDIR/tables/* ; do
		    psql $DBNAME -c "copy $tab to '/tmp/$tab';"
		done 
	fi
}

while test $# -gt 0 ; do
    case "${1}" in
	-h | --help )
	    COMMAND="usage"; shift ;;
	create )
	    COMMAND="create"; shift ;;
	drop )
	    COMMAND="drop"; shift ;;
	delete )
	    COMMAND="delete"; shift ;;
	load )
	    COMMAND="load"; shift ;;
	save )
	    COMMAND="save"; shift ;;
	* )
	    DBNAME="${1}"; shift ;;
    esac
done

case "$COMMAND" in
	"usage" )
		usage;;
	"create" )
		create;;
	"drop" )
		drop;;
	"delete" )
		delete;;
	"load" )
		load;;
	"save" )
		save;;
esac

